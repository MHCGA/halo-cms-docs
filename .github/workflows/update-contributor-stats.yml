name: Update Contributor Stats

on:
  pull_request:
    types: [closed]
    paths:
      - 'docs/**/*.md'
      - '!docs/.vitepress/**'

permissions:
  contents: write
  pull-requests: read

jobs:
  update-stats:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Update contributor stats
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          REVIEWERS_FILE=".github/REVIEWERS.json"
          
          AUTHOR_IN_REVIEWERS=$(jq --arg author "$PR_AUTHOR" \
            '.reviewers[] | select(.username == $author)' "$REVIEWERS_FILE")
          
          AUTHOR_IN_CONTRIBUTORS=$(jq --arg author "$PR_AUTHOR" \
            '.contributors[] | select(.username == $author)' "$REVIEWERS_FILE")
          
          AUTO_PROMOTE_THRESHOLD=$(jq -r '.rules.autoPromoteThreshold' "$REVIEWERS_FILE")
          
          if [ -n "$AUTHOR_IN_REVIEWERS" ]; then
            jq --arg author "$PR_AUTHOR" \
              '(.reviewers[] | select(.username == $author) | .approvedCount) += 1' \
              "$REVIEWERS_FILE" > tmp.json && mv tmp.json "$REVIEWERS_FILE"
            
            echo "Updated reviewer $PR_AUTHOR stats"
          elif [ -n "$AUTHOR_IN_CONTRIBUTORS" ]; then
            NEW_COUNT=$(jq --arg author "$PR_AUTHOR" \
              '.contributors[] | select(.username == $author) | .approvedCount + 1' \
              "$REVIEWERS_FILE")
            
            jq --arg author "$PR_AUTHOR" \
              '(.contributors[] | select(.username == $author) | .approvedCount) += 1' \
              "$REVIEWERS_FILE" > tmp.json && mv tmp.json "$REVIEWERS_FILE"
            
            if [ "$NEW_COUNT" -ge "$AUTO_PROMOTE_THRESHOLD" ]; then
              echo "Promoting $PR_AUTHOR to reviewer!"
              
              CONTRIBUTOR_DATA=$(jq --arg author "$PR_AUTHOR" \
                '.contributors[] | select(.username == $author)' "$REVIEWERS_FILE")
              
              jq --arg author "$PR_AUTHOR" --argjson data "$CONTRIBUTOR_DATA" \
                '.contributors |= map(select(.username != $author)) | 
                 .reviewers += [($data | . + {role: "reviewer", specialties: ["plugins", "themes", "plugin-theme-synergy", "usage", "misc"]})]' \
                "$REVIEWERS_FILE" > tmp.json && mv tmp.json "$REVIEWERS_FILE"
              
              gh issue create \
                --title "ðŸŽ‰ æ­å–œ @$PR_AUTHOR æ™‹å‡ä¸ºå®¡ç¨¿äººï¼" \
                --body "æ­å–œ @$PR_AUTHORï¼æ‚¨çš„ç¬¬ $NEW_COUNT ç¯‡æŠ•ç¨¿å·²é€šè¿‡å®¡æ ¸ï¼Œæ ¹æ®é¡¹ç›®è§„åˆ™ï¼Œæ‚¨å·²è‡ªåŠ¨æ™‹å‡ä¸ºå®¡ç¨¿äººã€‚å®¡ç¨¿äººæƒé™ï¼šå¯ä»¥å®¡æ ¸å…¶ä»–æŠ•ç¨¿ã€å‚ä¸Žé¡¹ç›®å†³ç­–è®¨è®ºã€åœ¨ REVIEWERS.json ä¸­è¢«åˆ—ä¸ºæ­£å¼å®¡ç¨¿äººã€‚æ„Ÿè°¢æ‚¨å¯¹ Halo CMS çŸ¥è¯†åº“ï¼ˆå£å·ï¼šMake Halo CMS Great Againï¼‰é¡¹ç›®çš„æŒç»­è´¡çŒ®ï¼" \
                --label "announcement"
            fi
          else
            AUTHOR_NAME=$(gh api "/users/$PR_AUTHOR" --jq '.name // .login')
            
            jq --arg username "$PR_AUTHOR" --arg name "$AUTHOR_NAME" \
              '.contributors += [{
                "username": $username,
                "name": $name,
                "approvedCount": 1
              }]' \
              "$REVIEWERS_FILE" > tmp.json && mv tmp.json "$REVIEWERS_FILE"
            
            echo "Added new contributor $PR_AUTHOR"
          fi

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet .github/REVIEWERS.json; then
            echo "No changes to commit"
          else
            git add .github/REVIEWERS.json
            git commit -m "chore: update contributor stats after PR #${{ github.event.pull_request.number }}"
            git push
          fi
