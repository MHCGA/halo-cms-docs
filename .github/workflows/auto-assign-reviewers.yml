name: Auto Assign Reviewers

on:
  pull_request:
    types: [opened, ready_for_review]
    paths:
      - 'docs/**/*.md'
      - '!docs/.vitepress/**'

permissions:
  pull-requests: write
  contents: read

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Assign reviewers and add labels
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          REVIEWERS_FILE=".github/REVIEWERS.json"
          
          if [ ! -f "$REVIEWERS_FILE" ]; then
            echo "Reviewers file not found: $REVIEWERS_FILE"
            exit 1
          fi
          
          MIN_REVIEWERS=$(jq -r '.rules.minReviewers' "$REVIEWERS_FILE")
          
          AVAILABLE_REVIEWERS=$(jq -r --arg author "$PR_AUTHOR" \
            '.reviewers[] | select(.username != $author) | .username' \
            "$REVIEWERS_FILE" | jq -R -s -c 'split("\n")[:-1]')
          
          REVIEWER_COUNT=$(echo "$AVAILABLE_REVIEWERS" | jq 'length')
          
          if [ "$REVIEWER_COUNT" -lt "$MIN_REVIEWERS" ]; then
            echo "Warning: Not enough reviewers available. Need $MIN_REVIEWERS, have $REVIEWER_COUNT"
            ASSIGN_COUNT=$REVIEWER_COUNT
          else
            ASSIGN_COUNT=$MIN_REVIEWERS
          fi
          
          SELECTED_REVIEWERS=$(echo "$AVAILABLE_REVIEWERS" | jq -c --argjson count "$ASSIGN_COUNT" \
            'if length > 0 then . | sort_by(. | @base64) | .[:$count] else [] end')
          
          if [ "$(echo "$SELECTED_REVIEWERS" | jq 'length')" -gt 0 ]; then
            echo "Assigning reviewers: $SELECTED_REVIEWERS"
            
            gh pr edit "$PR_NUMBER" --add-reviewer "$(echo "$SELECTED_REVIEWERS" | jq -r 'join(",")')"
            
            REVIEWER_NAMES=$(echo "$SELECTED_REVIEWERS" | jq -r '.[]' | sed 's/^/@/' | paste -sd ',' - | sed 's/,/, /g')
            
            gh pr comment "$PR_NUMBER" --body "ğŸ¤– **è‡ªåŠ¨åˆ†é…å®¡ç¨¿äºº** å·²è‡ªåŠ¨ä¸ºæ­¤ PR åˆ†é…å®¡ç¨¿äºº: $REVIEWER_NAMES æ ¹æ®é¡¹ç›®è§„åˆ™ï¼Œéœ€è¦è‡³å°‘ **$MIN_REVIEWERS** åå®¡ç¨¿äººæ‰¹å‡†æ‰èƒ½åˆå¹¶ã€‚ ğŸ’¡ æç¤ºï¼šç´¯è®¡ 3 ç¯‡æŠ•ç¨¿é€šè¿‡åï¼Œè´¡çŒ®è€…å°†è‡ªåŠ¨å‡çº§ä¸ºå®¡ç¨¿äººã€‚"
          else
            echo "No reviewers available to assign"
            gh pr comment "$PR_NUMBER" --body "âš ï¸ **æ— æ³•è‡ªåŠ¨åˆ†é…å®¡ç¨¿äºº** å½“å‰æ²¡æœ‰å¯ç”¨çš„å®¡ç¨¿äººã€‚è¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…æ‰‹åŠ¨å®¡æ ¸ã€‚"
          fi
          
          CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path')
          
          for file in $CHANGED_FILES; do
            if [[ "$file" =~ docs/(en/)?posts/plugins ]]; then
              gh pr edit "$PR_NUMBER" --add-label "category:plugins"
            elif [[ "$file" =~ docs/(en/)?posts/themes ]]; then
              gh pr edit "$PR_NUMBER" --add-label "category:themes"
            elif [[ "$file" =~ docs/(en/)?posts/plugin-theme-synergy ]]; then
              gh pr edit "$PR_NUMBER" --add-label "category:plugin-theme-synergy"
            elif [[ "$file" =~ docs/(en/)?posts/usage ]]; then
              gh pr edit "$PR_NUMBER" --add-label "category:usage"
            elif [[ "$file" =~ docs/(en/)?posts/misc ]]; then
              gh pr edit "$PR_NUMBER" --add-label "category:misc"
            fi
          done
